namespace cml.examples

import cml.generator.annotation.solidity.*

enum State
	CREATED LOCKED INACTIVE

@PullPayment
contract Purchase
	Integer value
	Party seller
	Party buyer
	State state

	clause Abort
		given state == State::CREATED
		party seller
		may abort

	clause ConfirmPurchase
		given state == State::CREATED
		party anyone
		may confirmPurchase

	clause ConfirmReceived
		given state == State::LOCKED
		party buyer
		may confirmReceived
	
	init(TokenTransaction t)
		caller.deposit(t.amount)
		seller = caller
		value = t.amount.toInteger() / 2
		ensure(2 * value == t.amount.toInteger(), "Value has to be even.")

	abort()
		state = State::INACTIVE
		seller.withdraw(token.quantity)
		
	confirmPurchase(TokenTransaction t)
		ensure(t.amount == 2 * value, "Value has to be even.")
		caller.deposit(t.amount)
		buyer = caller
		state = State::LOCKED

	confirmReceived()
		state = State::INACTIVE
		transfer(buyer, value)
		transfer(seller, token.quantity)